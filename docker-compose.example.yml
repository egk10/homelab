services:
  # Ceph is used for object and filesystem storage in this deployment.
  # The lab's production-ready Ceph cluster (RGW + CephFS) is expected to be mounted and available on the host.
  # - Mount CephFS on the Docker host at /mnt/ceph (see scripts/mount_cephfs_example.sh)
  # - Create RGW user and bucket with scripts/create_rgw_user_and_bucket.sh and populate .env with CEPH_S3_* values
  # The following services in this compose file will use /mnt/ceph for persistent data.

  # ================================
  # REVERSE PROXY & TLS TERMINATION
  # ================================
  # ================================
  # DATABASE LAYER
  # ================================
  immich-postgres:
    image: docker.io/tensorchord/pgvecto-rs:pg16-v0.3.0
    container_name: immich_postgres
    hostname: immich-postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER:-immich}
      POSTGRES_DB: ${POSTGRES_DB:-immich}
      POSTGRES_INITDB_ARGS: "--data-checksums --auth-host=trust"
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: ${TZ:-UTC}
    volumes:
      - /mnt/nvme/immich-db:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-immich}", "-d", "${POSTGRES_DB:-immich}"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 60s
    command: >
      postgres
      -c shared_preload_libraries=vectors.so
      -c search_path='"$$user", public, vectors'
      -c logging_collector=on
      -c max_wal_size=2GB
      -c shared_buffers=512MB
      -c wal_compression=on
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=500
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=64MB
      -c huge_pages=off
      -c min_wal_size=1GB
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  immich-redis:
    image: redis:7.2-alpine
    container_name: immich_redis
    hostname: immich-redis
    environment:
      TZ: ${TZ:-UTC}
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy noeviction
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
    volumes:
      - /mnt/nvme/immich-redis:/data
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nextcloud-db:
    image: mariadb:11.4
    container_name: nextcloud_db
    hostname: nextcloud-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: ${TZ:-UTC}
    volumes:
      - /mnt/nvme/nextcloud-db:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    command: >
      --transaction-isolation=READ-COMMITTED
      --log-bin=binlog
      --binlog-format=ROW

      --skip-innodb-read-only-compressed
      --innodb-buffer-pool-size=512M
      --innodb-log-file-size=128M
      --max-connections=200
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # APPLICATION LAYER
  # ================================
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_server
    hostname: immich-server
    environment:
      # Database Configuration
      DB_HOSTNAME: immich-postgres
      DB_USERNAME: ${POSTGRES_USER:-immich}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE_NAME: ${POSTGRES_DB:-immich}
      # Redis Configuration
      REDIS_HOSTNAME: immich-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # Server Configuration
      IMMICH_HOST: ${IMMICH_HOST:-0.0.0.0}
      IMMICH_PORT: ${IMMICH_PORT:-2283}
      # Performance & Optimization
      NODE_ENV: production
      LOG_LEVEL: log
      TZ: ${TZ:-UTC}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # S3FS-mounted storage (photos stored in Ceph S3 via S3FS)
      - /mnt/s3fs/immich:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "2283:2283"
    depends_on:
      # Database dependencies
      immich-postgres:
        condition: service_healthy
      immich-redis:
        condition: service_healthy
  # CRITICAL: ensure CephFS is mounted at /mnt/ceph on the Docker host before starting this service
    healthcheck:
      disable: true
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=immich"
      - "tsdproxy.container_port=2283"
      - "tsdproxy.scheme=http"
      - "tsdproxy.ephemeral=true"
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nextcloud:
    image: nextcloud:31-apache
    container_name: nextcloud
    hostname: nextcloud
    environment:
      MYSQL_HOST: nextcloud-db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      # Admin account configuration
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER:-admin}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
      NEXTCLOUD_TRUSTED_DOMAINS: ${NEXTCLOUD_DOMAIN:-nextcloud.your-tailscale-domain.ts.net}
      OVERWRITEPROTOCOL: https
      OVERWRITEHOST: ${NEXTCLOUD_DOMAIN:-nextcloud.your-tailscale-domain.ts.net}
      REDIS_HOST: immich-redis
      REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}
      PHP_MEMORY_LIMIT: 1024M
      PHP_UPLOAD_LIMIT: 16G
      # Performance optimizations
      APACHE_DISABLE_REWRITE_IP: 1
      NEXTCLOUD_UPDATE: 1
      SMTP_SECURE: ""
      # Startup performance improvements
      NC_default_phone_region: US
      TZ: ${TZ:-UTC}
    volumes:
      # Use S3FS mounted Nextcloud data (user data only)
      - /mnt/s3fs/nextcloud-data:/var/www/html/data
      - nextcloud_app:/var/www/html
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8081:80"
    depends_on:
      # Database dependencies
      nextcloud-db:
        condition: service_healthy
      immich-redis:
        condition: service_healthy
  # CRITICAL: ensure S3FS is mounted at /mnt/s3fs/nextcloud-data before starting this service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 90s
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=nextcloud"
      - "tsdproxy.container_port=80"
      - "tsdproxy.scheme=http"
      - "tsdproxy.ephemeral=true"
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  vaultwarden:
    image: vaultwarden/server:1.32.0-alpine
    container_name: vaultwarden
    hostname: vaultwarden
    environment:
      WEBSOCKET_ENABLED: "true"
      SIGNUPS_ALLOWED: "true"
      INVITATIONS_ALLOWED: "true"
      SHOW_PASSWORD_HINT: "false"
      DOMAIN: ${VAULTWARDEN_DOMAIN}
      ROCKET_PORT: 80
      EMERGENCY_ACCESS_ALLOWED: "true"
      SENDS_ALLOWED: "true"
      WEB_VAULT_ENABLED: "true"
      DATABASE_MAX_CONNS: 10
      # Mobile app compatibility fixes
      WEBSOCKET_ADDRESS: "0.0.0.0"
      WEBSOCKET_PORT: 3012
      PUSH_ENABLED: "false"
      PUSH_INSTALLATION_ID: ""
      PUSH_INSTALLATION_KEY: ""
      # API compatibility
      ORG_EVENTS_ENABLED: "true"
      EVENTS_DAYS_RETAIN: 365
      # Mobile sync improvements
      DATABASE_POOL_SIZE: 20
      # Enable admin panel for password reset - from .env file
      ADMIN_TOKEN: ${ADMIN_TOKEN}
      # Fix for Android app compatibility
      REQUIRE_DEVICE_EMAIL: "false"
      DISABLE_2FA_REMEMBER: "false"
      PASSWORD_ITERATIONS: 600000
      # Additional compatibility settings
      EXTENDED_LOGGING: "true"
      LOG_LEVEL: "info"
      TZ: ${TZ:-UTC}
      # Mobile app sync fixes
      IP_HEADER: "X-Forwarded-For"
      ICON_REDIRECT_CODE: "302"
      # Fix mobile sync issues
      DISABLE_ICON_DOWNLOAD: "false"
      RELOAD_TEMPLATES: "true"
    volumes:
      # Use S3 mounted storage instead of local volumes
      - /mnt/s3/vaultwarden:/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8083:80"
      - "3012:3012"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=vaultwarden"
      - "tsdproxy.container_port=80"
      - "tsdproxy.scheme=http"
      - "tsdproxy.websocket_port=3012"
      - "tsdproxy.websocket_path=/notifications/hub"
      - "tsdproxy.ephemeral=true"
    restart: always
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:2024.8
    container_name: homeassistant
    hostname: homeassistant
    privileged: true
    environment:
      TZ: ${TZ:-UTC}
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
      - /dev:/dev
    ports:
      - "8123:8123"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=homeassistant"
      - "tsdproxy.container_port=8123"
      - "tsdproxy.scheme=http"
      - "tsdproxy.ephemeral=true"
    restart: unless-stopped
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # MONITORING & MAINTENANCE
  # ================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    hostname: watchtower
    environment:
      TZ: ${TZ:-UTC}
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_REMOVE_VOLUMES: "true"
      WATCHTOWER_INCLUDE_STOPPED: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"
      WATCHTOWER_DEBUG: "true"
      WATCHTOWER_LOG_LEVEL: "info"
      WATCHTOWER_MONITOR_ONLY: "false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # TAILSCALE PROXY SERVICE
  # ================================
  tsdproxy:
    image: almeidapaulopt/tsdproxy:1
    container_name: tsdproxy
    hostname: tsdproxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./tsdproxy/datadir:/data
      - ./tsdproxy/config:/config
    ports:
      - "8082:8080"
    environment:
      TZ: ${TZ:-UTC}
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
    depends_on:
      - vaultwarden
      - immich-server
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  nextcloud_app:
    driver: local
  homeassistant_config:
    driver: local

networks:
  web:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-web
    ipam:
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
